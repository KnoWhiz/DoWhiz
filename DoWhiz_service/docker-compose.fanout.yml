services:
  ollama:
    image: ollama/ollama:latest
    ports:
      - "11434:11434"
    volumes:
      - ollama-models:/root/.ollama
    healthcheck:
      test: ["CMD-SHELL", "ollama list | grep -q phi3 || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 30
      start_period: 60s
    entrypoint: ["/bin/sh", "-c", "ollama serve & sleep 5 && ollama pull phi3:mini && wait"]

  fanout:
    build:
      context: ..
      dockerfile: Dockerfile
    image: dowhiz-service
    entrypoint: ["/app/inbound_fanout"]
    environment:
      FANOUT_HOST: "0.0.0.0"
      FANOUT_PORT: "9100"
      FANOUT_TIMEOUT_SECS: "15"
      FANOUT_TARGETS: "http://oliver:9001,http://maggie:9001,http://devin:9001,http://proto:9001"
    ports:
      - "9100:9100"
    depends_on:
      - oliver
      - maggie
      - devin
      - proto

  oliver:
    build:
      context: ..
      dockerfile: Dockerfile
    image: dowhiz-service
    environment:
      EMPLOYEE_ID: "little_bear"
      RUST_SERVICE_PORT: "9001"
      RUN_TASK_DOCKER_IMAGE: ""
      RUN_TASK_DOCKER_AUTO_BUILD: "0"
      CODEX_BYPASS_SANDBOX: "1"
      OLLAMA_URL: "http://ollama:11434"
      ROUTER_MODEL: "phi3:mini"
      OLLAMA_ENABLED: "true"
    ports:
      - "9001:9001"
    volumes:
      - ../DoWhiz_service/.env:/app/.env:ro
      - dowhiz-workspace-oliver:/app/.workspace
    depends_on:
      ollama:
        condition: service_healthy

  maggie:
    build:
      context: ..
      dockerfile: Dockerfile
    image: dowhiz-service
    environment:
      EMPLOYEE_ID: "mini_mouse"
      RUST_SERVICE_PORT: "9001"
      RUN_TASK_DOCKER_IMAGE: ""
      RUN_TASK_DOCKER_AUTO_BUILD: "0"
      OLLAMA_URL: "http://ollama:11434"
      ROUTER_MODEL: "phi3:mini"
      OLLAMA_ENABLED: "true"
    ports:
      - "9002:9001"
    volumes:
      - ../DoWhiz_service/.env:/app/.env:ro
      - dowhiz-workspace-maggie:/app/.workspace
    depends_on:
      ollama:
        condition: service_healthy

  devin:
    build:
      context: ..
      dockerfile: Dockerfile
    image: dowhiz-service
    environment:
      EMPLOYEE_ID: "sticky_octopus"
      RUST_SERVICE_PORT: "9001"
      RUN_TASK_DOCKER_IMAGE: ""
      RUN_TASK_DOCKER_AUTO_BUILD: "0"
      CODEX_BYPASS_SANDBOX: "1"
      OLLAMA_URL: "http://ollama:11434"
      ROUTER_MODEL: "phi3:mini"
      OLLAMA_ENABLED: "true"
    ports:
      - "9003:9001"
    volumes:
      - ../DoWhiz_service/.env:/app/.env:ro
      - dowhiz-workspace-devin:/app/.workspace
    depends_on:
      ollama:
        condition: service_healthy

  proto:
    build:
      context: ..
      dockerfile: Dockerfile
    image: dowhiz-service
    environment:
      EMPLOYEE_ID: "boiled_egg"
      RUST_SERVICE_PORT: "9001"
      RUN_TASK_DOCKER_IMAGE: ""
      RUN_TASK_DOCKER_AUTO_BUILD: "0"
      CODEX_BYPASS_SANDBOX: "1"
      OLLAMA_URL: "http://ollama:11434"
      ROUTER_MODEL: "phi3:mini"
      OLLAMA_ENABLED: "true"
      # BlueBubbles iMessage bridge (host.docker.internal reaches Mac host from container)
      BLUEBUBBLES_URL: "http://host.docker.internal:1234"
      BLUEBUBBLES_PASSWORD: "dowhiz-proto"
    ports:
      - "9004:9001"
    volumes:
      - ../DoWhiz_service/.env:/app/.env:ro
      - dowhiz-workspace-proto:/app/.workspace
    depends_on:
      ollama:
        condition: service_healthy

volumes:
  ollama-models:
  dowhiz-workspace-oliver:
  dowhiz-workspace-maggie:
  dowhiz-workspace-devin:
  dowhiz-workspace-proto:
